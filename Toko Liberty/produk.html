<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Katalog Produk Interaktif</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* ==================================== */
        /* STYLING (Sama seperti sebelumnya)    */
        /* ==================================== */
        .product-card {
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .product-img-container {
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 1rem;
            background-color: #fefefe;
            cursor: pointer;
        }

        .product-img-container img {
            max-height: 100%;
            width: auto;
            object-fit: contain;
        }

        .btn-wa {
            background-color: #25D366;
            color: white;
            transition: background-color 0.2s;
        }

        .btn-wa:hover {
            background-color: #1DA851;
        }

        /* MODAL STYLES */
        #product-modal {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease-out;
            z-index: 50;
        }

        #product-modal.hidden { display: none; }

        #modal-thumbnail-gallery {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .thumbnail-item {
            cursor: pointer;
            padding: 2px;
            margin-bottom: 8px;
            transition: border-color 0.2s;
            border: 2px solid transparent;
        }

        .thumbnail-item:hover { border-color: #d1d5db; }
        .thumbnail-item.active { border-color: #3b82f6 !important; }

        .size-button {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .size-button:hover { border-color: #3b82f6; }
        .size-button.active { border-color: #3b82f6; background-color: #eff6ff; }

        /* SIZE GUIDE MODAL */
        #size-guide-modal { z-index: 60; }
        #size-guide-modal.hidden { display: none; }
        .size-table th, .size-table td { padding: 12px; border: 1px solid #e5e7eb; }
        .size-table tbody tr:nth-child(even) { background-color: #f9fafb; }
        .size-table { border-collapse: collapse; }
        
        /* Loading Indicator */
        #loading-indicator {
            display: flex;
            justify-content: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #4b5563;
        }
    </style>
</head>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyC-Yy3nBhGrND6ZmgcMZ_sjE-aKN0lkL8o",
      authDomain: "tokolibertyproject.firebaseapp.com",
      projectId: "tokolibertyproject",
      storageBucket: "tokolibertyproject.firebasestorage.app",
      messagingSenderId: "300142124191",
      appId: "1:300142124191:web:7deb307397e945070bd6aa",
      measurementId: "G-B41D2CS5GT"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
</script>

<body class="min-h-screen">

    <header class="navbar bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center py-4">
            <img src="assets/logo.png" class="logo rounded" width="80" alt="Logo Perusahaan">
            <ul class="flex space-x-6 ml-auto" id="nav-links">
                <li><a href="index.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-150">Home</a></li>
                <li><a href="produk.html" class="text-blue-600 border-b-2 border-blue-600 font-bold">Produk</a></li>
                <li><a href="about.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-150">Tentang Kami</a></li>
                <li><a href="kontak.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-150">Kontak</a></li>
                <li id="login-nav-item"><a href="login.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-150">Login</a></li>
            </ul>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <section class="page-title mb-8 bg-blue-50 p-6 rounded-xl text-center">
            <h2 class="text-3xl font-extrabold text-blue-800">Katalog Produk</h2>
            <p class="text-gray-600 mt-2">Temukan sepatu impian Anda dari berbagai brand ternama.</p>
        </section>

        <section class="filters bg-white shadow-lg p-6 mb-8 rounded-xl">
            <form id="filter-form" class="flex flex-col md:flex-row gap-4 items-center">
                <input type="text" id="search-input" name="q" placeholder="Cari nama produk..."
                    class="w-full md:flex-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                <select id="category-select" name="category"
                    class="w-full md:w-56 p-3 border border-gray-300 rounded-lg bg-white appearance-none focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    <option value="all">Semua Merek</option>
                    <option value="nike">Nike</option>
                    <option value="adidas">Adidas</option>
                    <option value="hoka">Hoka</option>
                    <option value="puma">Puma</option>
                    <option value="converse">Converse</option>
                    <option value="vans">Vans</option>
                </select>
            </form>
        </section>

        <!-- AREA PRODUK DINAMIS (KOSONGKAN DI SINI) -->
        <div id="loading-indicator">Sedang memuat produk dari Database...</div>
        
        <section class="products-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"
            id="product-grid">
            <!-- Kartu produk akan dimasukkan secara otomatis di sini oleh JavaScript -->
        </section>

    </main>

    <!-- MODAL UTAMA -->
    <div id="product-modal"
        class="hidden fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-75 backdrop-blur-sm p-4 sm:p-8"
        onclick="closeModal(event)">

        <div class="modal-content bg-white rounded-xl shadow-2xl max-w-5xl mx-auto my-8 transform transition-all duration-300 relative"
            onclick="event.stopPropagation()">

            <button onclick="document.getElementById('product-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 z-10 p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <div class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="flex space-x-4">
                    <div id="modal-thumbnail-gallery" class="flex flex-col items-center"></div>
                    <div class="relative flex-grow flex items-center justify-center">
                        <img id="modal-main-image" src="" alt="Foto Utama Produk" class="max-w-full max-h-[500px] object-contain rounded-lg">
                        <button id="modal-prev-btn" class="absolute left-0 p-2 text-gray-500 hover:text-gray-800 transition bg-white bg-opacity-70 rounded-full ml-2 shadow-md">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <button id="modal-next-btn" class="absolute right-0 p-2 text-gray-500 hover:text-gray-800 transition bg-white bg-opacity-70 rounded-full mr-2 shadow-md">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="product-details p-4">
                    <h1 id="modal-product-title" class="text-3xl font-bold text-gray-900 mb-2"></h1>
                    <p id="modal-product-desc" class="text-sm text-gray-500 mb-4"></p>
                    <div class="price-section mb-6">
                        <span id="modal-current-price" class="text-4xl font-extrabold text-red-600"></span>
                    </div>
                    <div class="border-t border-gray-200 pt-4 mb-4"></div>
                    
                    <div class="size-section mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <p class="font-semibold text-gray-700">UKURAN (Tersedia)</p>
                            <a href="#" onclick="openSizeGuide(event)" class="text-blue-600 text-sm hover:underline">Panduan Ukuran</a>
                        </div>
                        <div id="modal-size-options-container" class="flex flex-wrap gap-2">
                            <!-- Ukuran akan di-generate otomatis -->
                        </div>
                    </div>

                    <div class="quantity-section mb-8">
                        <p class="font-semibold text-gray-700 mb-2">JUMLAH</p>
                        <select id="modal-quantity" class="p-2 border border-gray-300 rounded-md w-20">
                            <option>1</option><option>2</option><option>3</option>
                        </select>
                    </div>

                    <a id="modal-wa-link" href="#" target="_blank"
                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition duration-200 text-center block">
                        BELI SEKARANG / PESAN VIA WHATSAPP
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SIZE GUIDE (SAMA) -->
    <div id="size-guide-modal" class="hidden fixed inset-0 z-[60] overflow-y-auto bg-black bg-opacity-80 p-4" onclick="closeSizeGuide(event)">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl mx-auto my-16 transform transition-all duration-300 relative" onclick="event.stopPropagation()">
            <button onclick="document.getElementById('size-guide-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 z-10 p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="p-6 md:p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Panduan Ukuran</h2>
                <div class="overflow-x-auto">
                    <table class="size-table w-full text-center border-collapse text-sm">
                        <thead><tr class="bg-gray-100"><th class="p-3 border border-gray-300">US</th><th class="p-3 border border-gray-300">EUR</th><th class="p-3 border border-gray-300">CM</th></tr></thead>
                        <tbody>
                            <tr><td>7</td><td>40</td><td>25</td></tr>
                            <tr><td>8</td><td>41</td><td>26</td></tr>
                            <tr><td>9</td><td>42.5</td><td>27</td></tr>
                            <tr><td>10</td><td>44</td><td>28</td></tr>
                            <tr><td>11</td><td>45</td><td>29</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="main.js"></script>

    <!-- SCRIPT UTAMA -->
    <script>
        // Variabel Global untuk Data Produk
        let allProducts = [];
        let currentGallery = [];
        let currentImageIndex = 0;
        let currentBasePrice = 0;
        let currentProductName = '';

        // Format Rupiah
        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        };

        // 1. MENGAMBIL DATA DARI FIREBASE
        document.addEventListener('DOMContentLoaded', () => {
            const productsGrid = document.getElementById('product-grid');
            const loadingIndicator = document.getElementById('loading-indicator');

            db.collection("products").orderBy("createdAt", "desc").get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    // Gabungkan ID dokumen dengan datanya
                    const data = doc.data();
                    data.id = doc.id;
                    allProducts.push(data);
                });

                // Sembunyikan loading, Tampilkan Produk
                loadingIndicator.style.display = 'none';
                renderProducts(allProducts);
                
            }).catch((error) => {
                console.error("Error fetching products:", error);
                loadingIndicator.textContent = "Gagal memuat produk. Coba muat ulang.";
            });

            // Listener untuk Filter dan Search
            const searchInput = document.getElementById('search-input');
            const categorySelect = document.getElementById('category-select');

            const filterProducts = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const category = categorySelect.value;

                const filtered = allProducts.filter(product => {
                    const matchName = product.name.toLowerCase().includes(searchTerm);
                    const matchCat = category === 'all' || product.category === category;
                    return matchName && matchCat;
                });

                renderProducts(filtered);
            };

            searchInput.addEventListener('input', filterProducts);
            categorySelect.addEventListener('change', filterProducts);
        });

        // 2. FUNGSI RENDER PRODUK KE HTML
        function renderProducts(products) {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = ''; // Bersihkan grid

            if (products.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center text-gray-500">Tidak ada produk ditemukan.</p>';
                return;
            }

            products.forEach(product => {
                // Siapkan string galeri (dipisahkan koma) untuk data attribute
                const galleryString = product.gallery ? product.gallery.join(',') : product.imageUrl;
                
                // Buat kartu HTML
                const cardHTML = `
                    <article class="product-card h-full flex flex-col" 
                        onclick="openModalFromData(this)"
                        data-name="${product.name}" 
                        data-price="${product.price}"
                        data-desc="${product.description}"
                        data-gallery="${galleryString}">
                        
                        <div class="product-img-container">
                            <img src="${product.imageUrl}" alt="${product.name}" loading="lazy">
                        </div>
                        
                        <div class="p-4 flex flex-col flex-grow">
                            <h3 class="text-lg font-bold text-gray-800 mb-1 uppercase">${product.category}</h3>
                            <h3 class="text-sm font-medium text-gray-600 mb-2 line-clamp-2 h-10">${product.name}</h3>
                            <div class="price text-xl font-extrabold text-red-600 mb-2">${formatRupiah(product.price)}</div>
                            
                            <div class="actions flex gap-3 mt-auto pt-4">
                                <button class="btn-wa w-full text-sm py-2 px-3 rounded-md font-medium text-center shadow-md">
                                    Lihat Detail
                                </button>
                            </div>
                        </div>
                    </article>
                `;
                grid.innerHTML += cardHTML;
            });
        }

        // 3. LOGIKA MODAL (DINAMIS)
        function openModalFromData(card) {
            const name = card.getAttribute('data-name');
            const price = parseFloat(card.getAttribute('data-price'));
            const desc = card.getAttribute('data-desc');
            const galleryRaw = card.getAttribute('data-gallery');
            
            currentProductName = name;
            currentBasePrice = price;
            currentGallery = galleryRaw.split(',');
            currentImageIndex = 0;

            // Isi konten modal
            document.getElementById('modal-product-title').textContent = name;
            document.getElementById('modal-product-desc').textContent = desc || "Deskripsi produk detail.";
            document.getElementById('modal-current-price').textContent = formatRupiah(price);

            // Render Gambar
            renderThumbnails();
            
            // Render Ukuran (Generic Generator karena data size belum di migrasi)
            renderGenericSizes();

            // Tampilkan Modal
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function renderThumbnails() {
            const container = document.getElementById('modal-thumbnail-gallery');
            container.innerHTML = '';
            
            // Set gambar utama
            document.getElementById('modal-main-image').src = currentGallery[0];

            currentGallery.forEach((imgUrl, index) => {
                const div = document.createElement('div');
                div.className = `thumbnail-item ${index === 0 ? 'active' : ''}`;
                div.innerHTML = `<img src="${imgUrl}" class="w-16 h-16 object-cover rounded">`;
                div.onclick = () => {
                    currentImageIndex = index;
                    document.getElementById('modal-main-image').src = imgUrl;
                    document.querySelectorAll('.thumbnail-item').forEach(el => el.classList.remove('active'));
                    div.classList.add('active');
                };
                container.appendChild(div);
            });
        }

        function renderGenericSizes() {
            const container = document.getElementById('modal-size-options-container');
            container.innerHTML = '';
            // Ukuran standar sepatu
            const sizes = ['US 7', 'US 8', 'US 9', 'US 10', 'US 11'];
            
            sizes.forEach((size, index) => {
                const btn = document.createElement('button');
                btn.className = `size-button ${index === 0 ? 'active' : ''}`; // Default pilih pertama
                btn.textContent = size;
                btn.onclick = (e) => {
                    document.querySelectorAll('.size-button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    updateWaLink(size);
                };
                container.appendChild(btn);
            });
            updateWaLink(sizes[0]); // Init link WA
        }

        function updateWaLink(size) {
            const qty = document.getElementById('modal-quantity').value;
            const message = `Halo, saya ingin memesan: \nNama: ${currentProductName} \nUkuran: ${size} \nJumlah: ${qty} \nHarga: ${formatRupiah(currentBasePrice)}`;
            const link = `https://wa.me/6282288187742?text=${encodeURIComponent(message)}`;
            document.getElementById('modal-wa-link').href = link;
        }

        // Navigasi Gambar Modal
        document.getElementById('modal-prev-btn').addEventListener('click', () => {
            if(currentImageIndex > 0) {
                currentImageIndex--;
                document.querySelectorAll('.thumbnail-item')[currentImageIndex].click();
            }
        });
        document.getElementById('modal-next-btn').addEventListener('click', () => {
            if(currentImageIndex < currentGallery.length - 1) {
                currentImageIndex++;
                document.querySelectorAll('.thumbnail-item')[currentImageIndex].click();
            }
        });

        // Listener Quantity
        document.getElementById('modal-quantity').addEventListener('change', () => {
            const activeSize = document.querySelector('.size-button.active').textContent;
            updateWaLink(activeSize);
        });

        function closeModal(e) {
            if (e.target.id === 'product-modal') {
                document.getElementById('product-modal').classList.add('hidden');
            }
        }
        
        // Size Guide Modal Logic
        function openSizeGuide(e) { e.preventDefault(); document.getElementById('size-guide-modal').classList.remove('hidden'); }
        function closeSizeGuide(e) { if (e.target.id === 'size-guide-modal') document.getElementById('size-guide-modal').classList.add('hidden'); }

    </script>
</body>
</html>